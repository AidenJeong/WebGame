<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>TwinTether</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app">
    <canvas id="game" tabindex="0"></canvas>

    <!-- HUD -->
    <div id="hud">
      <div id="hearts"></div>
      <div id="status">
        <span id="powerLevel">Lines: 1</span>
        <span id="waveInfo"></span>
      </div>
    </div>

    <!-- 시작 오버레이: onclick으로 '직접' 시작 보장 -->
    <div id="overlay" class="center">
      <div class="panel">
        <h1>TwinTether</h1>
        <p>두 원을 움직여 라인으로 적을 베어내세요!</p>
        <button id="startBtn" onclick="_startGame()">시작하기</button>
      </div>
    </div>

    <!-- 팝업(게임오버/클리어) -->
    <div id="popup" class="hidden"></div>
  </div>

  <!-- 스크립트: 의존 순서대로 (모듈 사용 안 함) -->
  <script src="src/ui.js"></script>
  <script src="src/utils.js"></script>       <!-- Vec2, rand, clamp 등 (프로젝트에 있는 이름에 맞춰 두세요) -->
  <script src="src/entities.js"></script>
  <script src="src/waves.js"></script>
  <script src="src/input.js"></script>
  <script src="src/main.js"></script>
  <script src="src/game.js"></script>

  <!-- 시작 버튼이 '항상' 동작하도록 보장하는 최후방 안전장치 -->
<script>
  // 전역 안전 시작 함수(버튼 onclick으로 직접 호출)
  function _startGame(){
    try{
      // 오버레이 먼저 숨기고 캔버스 입력 켜기
      var overlay = document.getElementById('overlay');
      var canvas  = document.getElementById('game');
      if (overlay) overlay.classList.add('hidden');
      if (canvas)  canvas.style.pointerEvents = 'auto';

      // Game 생성자 존재 확인
      if (!window.Game || typeof window.Game !== 'function') {
        throw new Error('Game 생성자를 찾을 수 없습니다 (스크립트 로드 순서/경로 확인).');
      }

      // ❗ 항상 새 인스턴스로 초기화 (기존 window.game에 이상한 객체가 남아있을 수 있음)
      var cv = document.getElementById('game');
      window.game = new window.Game(cv);

      // ❗ start가 없을 때 _startImpl 폴백 호출
      if (window.game && typeof window.game.start === 'function') {
        window.game.start();
      } else if (window.game && typeof window.game._startImpl === 'function') {
        window.game._startImpl();
      } else {
        // 디버깅 정보를 함께 표시
        var t1 = typeof window.game;
        var keys = window.game ? Object.keys(window.game).join(',') : 'null';
        throw new Error('Game.start 가 없습니다. type=' + t1 + ', keys=[' + keys + ']');
      }
    }catch(err){
      alert('초기화 오류: ' + (err && err.message ? err.message : err));
    }
  }
</script>
</body>
</html>
